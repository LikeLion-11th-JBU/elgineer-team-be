<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시글 상세</title>
</head>
<body data-post-id="${post.id}">

<h1 th:text="${post.title}">게시글 제목</h1>
<p th:text="${post.content}">게시글 내용</p>

<!-- 좋아요 버튼 -->
<button id="likeButton" onclick="addLike()">👍 좋아요</button>

<!-- 좋아요 취소 버튼 -->
<button id="unlikeButton" onclick="removeLike()">👍 좋아요 취소</button>


<!-- 로그인한 사용자와 게시글 작성자가 동일한 경우에만 수정 및 삭제 버튼 표시 -->
<div th:if="${loggedInUserNickname == post.writerNickname}">
    <!-- 게시글 수정 -->
    <a th:href="@{'/board/update/' + ${post.id}}"><button>게시글 수정</button></a>

    <!-- 게시글 삭제 -->
    <button onclick="deletePost(${post.id})">게시글 삭제</button>
</div>

<h2>댓글</h2>

<!-- 댓글 작성 폼 -->
<form id="commentForm">
    <textarea name="content" id="commentContent" placeholder="댓글을 입력하세요."></textarea>
    <button type="button" onclick="createComment()">댓글 작성</button>
</form>

<!-- 댓글 목록 -->
<div th:each="comment : ${comments}">
    <p th:text="${comment.content}">댓글 내용</p>

    <!-- 로그인한 사용자와 댓글 작성자가 동일한 경우만 수정 및 삭제 버튼 표시 -->
    <div th:if="${loggedInUserNickname == comment.writerNickname}">

        <!-- 댓글 수정 -->
        <button onclick="showEditBox(this)">수정</button>
        <div class="edit-box" style="display: none;">
            <textarea th:text="${comment.content}"></textarea>
            <button onclick="updateComment(this, ${comment.id})">저장</button>
        </div>

        <!-- 댓글 삭제 -->
        <button onclick="deleteComment(${comment.id})">삭제</button>

    </div>
</div>

<script>
    const postId = document.body.getAttribute('data-post-id');

    function deletePost(postId) {
        const confirmDelete = confirm("게시글을 삭제하시겠습니까?");
        if (confirmDelete) {
            fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "/board/list";
                } else {
                    alert("게시글 삭제에 실패하였습니다.");
                }
            });
        }
    }

    function createComment() {
        const content = document.getElementById('commentContent').value;
        fetch(`/comments/${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            location.reload();
        });
    }

    function showEditBox(button) {
        const editBox = button.nextElementSibling;
        editBox.style.display = 'block';
    }

    function updateComment(button, commentId) {
        const editedContent = button.previousElementSibling.value;
        fetch(`/comments/${commentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: editedContent })
        })
        .then(response => response.json())
        .then(data => {
            location.reload();
        });
    }

    function deleteComment(commentId) {
        const confirmDelete = confirm("댓글을 삭제하시겠습니까?");
        if (confirmDelete) {
            fetch(`/comments/${commentId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("댓글 삭제에 실패하였습니다.");
                }
            });
        }
    }

    function addLike() {
        fetch(`/api/posts/${postId}/like`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // 여기에 좋아요 수를 업데이트하는 로직 등이 필요하다면 추가
        });
    }

    function removeLike() {
        fetch(`/api/posts/${postId}/like`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // 여기에 좋아요 수를 업데이트하는 로직 등이 필요하다면 추가
        });
    }
</script>

</body>
</html>
